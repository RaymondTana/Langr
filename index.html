<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Langr - Language Guessing Game</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="instructions-btn" onclick="showInstructions()">Instructions</button>
    
    <div class="game-container">
        <h1 class="game-title">Langr</h1>
        
        <div class="guess-section">
            <div class="guess-counter">Guess: <span id="guessCount">1</span></div>
            <select class="language-select" id="languageSelect">
                <option value="">Select a language...</option>
            </select>
            <button class="guess-btn" id="guessBtn">Guess!</button>
            <div id="incorrectMessage" class="incorrect-guess" style="display: none;"></div>
        </div>

        <div class="clues-section" id="cluesSection">
            <!-- Clues will be populated here -->
        </div>
    </div>

    <!-- Instructions Modal -->
    <div class="modal-overlay" id="instructionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">How to Play Langr</h2>
                <button class="close-btn" onclick="hideInstructions()">&times;</button>
            </div>
            <div class="instructions-content">
                <p>Welcome to <strong>Langr</strong> - the daily language guessing game!</p>
                
                <h3>Objective</h3>
                <p>Guess the mystery language using the clues provided. Each day features a new language with authentic audio and text samples.</p>
                
                <h3>How It Works</h3>
                <ul>
                    <li>You'll receive clues one-by-one to help identify the language.</li>
                    <li>Make your guess using the dropdown menu.</li>
                    <li>If incorrect, you'll get the next clue.</li>
                    <li>Keep guessing until you find the right answer!</li>
                </ul>
                
                <h3>Clue Order</h3>
                <ol>
                    <li><strong>üîä Audio Sample</strong> - Listen to a native speake.</li>
                    <li><strong>üî§ English Translation</strong> - Understand what was said.</li>
                    <li><strong>üå≥ Language Family</strong> - Learn about linguistic relationships.</li>
                    <li><strong>üìù Original Text</strong> - See the text in its original script.</li>
                </ol>
                
                <p><strong>Good luck and have fun learning about languages from around the world! üåç</strong></p>
            </div>
        </div>
    </div>

    <script>
        // Game data - will be populated from CSV
        let gameData = {
            languages: [],
            todaysLanguage: null
        };

        let currentClueIndex = 0;
        let guessCount = 1;
        let gameEnded = false;

        // Initialize game
        async function initGame() {
            try {
                await loadGameData();
                populateLanguageSelect();
                setupEventListeners();
                showNextClue(); // Show first clue after data is loaded
            } catch (error) {
                console.error('Failed to initialize game:', error);
                showError('Failed to load game data. Please refresh the page.');
            }
        }

        // Load and parse CSV data
        async function loadGameData() {
            try {
                const response = await fetch('game_data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                // Parse CSV
                const rows = parseCSV(csvText);
                if (rows.length === 0) {
                    throw new Error('No data found in CSV file');
                }
                
                // Get today's date in YYYY-MM-DD format
                const today = localISODate();
                
                // Find today's row
                const todaysRow = rows.find(row => row.date === today);
                if (!todaysRow) {
                    throw new Error(`No data found for today's date: ${today}`);
                }
                
                // Extract unique languages for dropdown
                // const uniqueLanguages = [...new Set(rows.map(row => row.language))].sort();
                
                // Set game data
                gameData = {
                    // languages: uniqueLanguages,
                    languages: ['Afrikaans', 'Albanian', 'Armenian', 'Bulgarian', 'Cantonese', 'Catalan', 'Chinese', 'Czech', 'Danish', 'Dutch', 'English', 'Esperanto', 'Estonian', 'Finnish', 'French', 'Georgian', 'German', 'Greek', 'Hindi', 'Hungarian', 'Icelandic', 'Indonesian', 'Irish', 'Italian', 'Latvian', 'Lithuanian', 'Macedonian', 'Malayalam', 'Nepali', 'Persian', 'Polish', 'Portuguese', 'Punjabi', 'Romanian', 'Russian', 'Serbian', 'Slovak', 'Spanish', 'Swahili', 'Swedish', 'Tamil', 'Turkish', 'Vietnamese', 'Welsh'],
                    todaysLanguage: todaysRow
                };
                
                console.log('Game data loaded successfully:', gameData);
                
            } catch (error) {
                console.error('Error loading CSV data:', error);
                throw error;
            }
        }

        // Get local date in YYYY-MM-DD format
        function localISODate() {
            const d = new Date();
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 10); // YYYY-MM-DD
        }
        
        // Simple CSV parser
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            // Get headers
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            
            // Parse data rows
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    rows.push(row);
                }
            }
            
            return rows;
        }

        // Parse a single CSV line (handles quoted values with commas)
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values.map(value => value.replace(/"/g, ''));
        }

        function showError(message) {
            const gameContainer = document.querySelector('.game-container');
            gameContainer.innerHTML = `
                <h1 class="game-title">Langr</h1>
                <div style="padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
        }

        function populateLanguageSelect() {
            const select = document.getElementById('languageSelect');
            gameData.languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang;
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('guessBtn').addEventListener('click', makeGuess);
            document.getElementById('languageSelect').addEventListener('change', function() {
                document.getElementById('guessBtn').disabled = !this.value;
            });
        }

        function makeGuess() {
            if (gameEnded) return;

            const selectedLanguage = document.getElementById('languageSelect').value;
            const incorrectMessage = document.getElementById('incorrectMessage');
            
            if (!selectedLanguage) return;

            if (selectedLanguage === gameData.todaysLanguage.language) {
                showCelebration();
                gameEnded = true;
            } else {
                // Show incorrect message
                incorrectMessage.textContent = `Incorrect! "${selectedLanguage}" is not the right answer.`;
                incorrectMessage.style.display = 'block';
                
                // Hide message after 3 seconds
                setTimeout(() => {
                    incorrectMessage.style.display = 'none';
                }, 3000);

                // Show next clue
                showNextClue();
                guessCount++;
                document.getElementById('guessCount').textContent = guessCount;
            }

            // Reset selection
            document.getElementById('languageSelect').value = '';
            document.getElementById('guessBtn').disabled = true;
        }

        function showNextClue() {
            const cluesSection = document.getElementById('cluesSection');
            const clues = [
                {
                    type: 'audio',
                    header: 'üîä Audio Clue',
                    content: createAudioClue()
                },
                {
                    type: 'translation',
                    header: 'üî§ English Translation',
                    content: `<div class="text-content">${gameData.todaysLanguage.translation}</div>`
                },
                {
                    type: 'family',
                    header: 'üå≥ Language Family',
                    content: createFamilyClue()
                },
                {
                    type: 'text',
                    header: 'üìù Original Text',
                    content: `<div class="text-content">${gameData.todaysLanguage.sentence}</div>`
                }
            ];

            if (currentClueIndex < clues.length) {
                const clueDiv = document.createElement('div');
                clueDiv.className = 'clue';
                clueDiv.innerHTML = `
                    <div class="clue-header">${clues[currentClueIndex].header}</div>
                    ${clues[currentClueIndex].content}
                `;
                cluesSection.appendChild(clueDiv);
                currentClueIndex++;
            }
        }

        function createAudioClue() {
            // Get today's date in YYYY-MM-DD format
            const today = localISODate();

            console.log('Today is:', today);
            console.log('Audio file for today:', gameData.todaysLanguage.wave);

            // Get audio file
            const audioId = "audio-clue-" + today; 
            const srcPath = `assets/audio/${gameData.todaysLanguage.wave}`;

            return `
                <div class="audio-player">
                    <audio id="${audioId}" src="${srcPath}"></audio>

                    <button class="play-btn" onclick="togglePlay('${audioId}', this)">
                        ‚ñ∂
                    </button>

                    <div class="audio-info">
                        <div>Audio sample</div>
                        <div>Sample rate: ${gameData.todaysLanguage.sampling_rate} Hz</div>
                    </div>
                </div>
            `;
        }

        function togglePlay(audioId, btn) {
            const player = document.getElementById(audioId);

            if (player.paused) {
                // ensure we always start from the beginning when replaying
                player.currentTime = 0;
                player.play();
                btn.textContent = "‚è∏";
                player.onended = () => (btn.textContent = "‚ñ∂");
            } else {
                player.pause();
                btn.textContent = "‚ñ∂";
            }
        }

        function createFamilyClue() {
            const families = [
                gameData.todaysLanguage.family_0,
                gameData.todaysLanguage.family_1,
                gameData.todaysLanguage.family_2
            ].filter(f => f && f.trim() !== '');
            
            return `<div class="text-content">${families.join(' ‚Üí ')}</div>`;
        }

        function playAudio() {
            // Play the actual audio file
            const playBtn = event.target;
            const audioFile = gameData.todaysLanguage.wave;
            
            if (audioFile && audioFile.trim() !== '') {
                try {
                    const audio = new Audio(audioFile);
                    
                    // Update button to show playing state
                    playBtn.innerHTML = '‚è∏';
                    playBtn.style.background = '#e74c3c';
                    
                    // Play audio
                    audio.play().catch(error => {
                        console.error('Error playing audio:', error);
                        alert('Could not play audio file. Make sure the file exists and is accessible.');
                    });
                    
                    // Reset button when audio ends
                    audio.addEventListener('ended', () => {
                        playBtn.innerHTML = '‚ñ∂';
                        playBtn.style.background = '#27ae60';
                    });
                    
                    // Reset button after 30 seconds max (in case audio doesn't fire 'ended' event)
                    setTimeout(() => {
                        playBtn.innerHTML = '‚ñ∂';
                        playBtn.style.background = '#27ae60';
                    }, 30000);
                    
                } catch (error) {
                    console.error('Error creating audio element:', error);
                    alert('Could not load audio file.');
                    playBtn.innerHTML = '‚ñ∂';
                    playBtn.style.background = '#27ae60';
                }
            } else {
                alert('No audio file specified for today\'s language.');
            }
        }

        function showCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.innerHTML = `
                <div class="celebration-content">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">üéâ Congratulations! üéâ</h2>
                    <p style="font-size: 18px; margin-bottom: 10px;">You guessed it correctly!</p>
                    <p style="font-size: 24px; font-weight: 600; color: #3498db;">The language was ${gameData.todaysLanguage.language}!</p>
                    <p style="margin-top: 20px; color: #666;">You solved it in ${guessCount} guess${guessCount > 1 ? 'es' : ''}!</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Play Again</button>
                </div>
            `;
            
            // Add confetti
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = ['#3498db', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6'][Math.floor(Math.random() * 5)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                celebration.appendChild(confetti);
            }
            
            document.body.appendChild(celebration);
        }

        // Start the game
        initGame(); // This will now load CSV data first, then show the first clue

        // Instructions modal functions
        function showInstructions() {
            document.getElementById('instructionsModal').classList.add('active');
        }

        function hideInstructions() {
            document.getElementById('instructionsModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('instructionsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideInstructions();
            }
        });

        // CSV Reading Function (for when you have actual CSV data)
        // This is now implemented above in loadGameData() function
        
        // Expected CSV format:
        // date,language,wave,sampling_rate,sentence,translation,family_0,family_1,family_2
        // 2025-06-12,Spanish,spanish_audio.wav,22050,"¬°Hola! ¬øC√≥mo est√°s?","Hello! How are you?",Indo-European,Romance,Ibero-Romance
    </script>
</body>
</html>